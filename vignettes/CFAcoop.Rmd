---
title: "CFAcoop"
output: 
  rmarkdown::html_vignette:
    fig_width: 7
    fig_heigth: 9
vignette: >
  %\VignetteIndexEntry{CFAcoop}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# How to use this package (and why) 

## Introduction  

The **CFAcoop** package equips you with functions to analyse data from the 
clonogenic assay (also called 'Colony Formation Assay') 
in presence or absence of cell cooperation. 
Thus, this package allows you to robustly extract clonogenic survival 
information for your cell lines under a given treatment. 

This vignette is meant to enable you to process your data following the method 
first presented in Brix et al., Radiation Biology, 2020: 
"The clonogenic assay: robustness of plating efficiency-based analysis is 
strongly compromised by cellular cooperation".
Therefore the data presented in Brix et al., which is provided within the 
package, is used for illustration of how to use the CFAcoop package.
Further, it is shown, how the survival 
fractions of cooperative cell lines would look like, when the cellular 
cooperation is ignored.

## Cellular Cooperation ##

In order to avoid confusion, cellular cooperation should be defined.
Understanding this concept comes easy, when starting from the opposite.
Non-cooperative cells grow or die independently from each other.
Thus, there is a constant relationship between cells seeded $S$ and colonies 
counted $C$:
\[C = a \cdot S,\]
where $a$ corresponds just to the conventional plating efficiency 
($PE = \frac{C}{S}$).

Now, cellular cooperation refers to the benefit cells can have from their 
surrounding neighbors which results in a non-constant relation of cells seeded 
and colonies counted.
Growth becomes initiated or increasingly efficient by increasing 
numbers of surrounding cells to cooperate with.
It has turned out, that generalizing the equation above by a parameter $b$ 
adequately models the colonies counted of cooperative and non-cooperative cell 
lines
\[C = a \cdot S^b.\]
In this model, $b = 1$ gives the non-cooperative case and $b > 1$ corresponds to 
cooperative growth.

In short, a cell line is called cooperative, if $b > 1$.

## Clonogenic Survival ##

Conventionally, clonogenic survival was determined as the plating efficiency 
under a certain treatment $PE_x$ scaled to the plating efficiency of a reference 
$PE_0$
\[SF'_x = \frac{PE_x}{PE_0}.\]

The new method now shifts the focus of the survival fraction 
directly to the number of cells needed to be seeded under the two conditions 
(treated and untreated) in order to achieve an identical expectation of the 
number of colonies formed $C$.
Thereby, implicitely addressing the fraction of non-clonogenic cells before 
cooperation can take place and thus filtering this effect out of the analysis. 
Essentially, the new method does not focus on the number of colonies formed 
after growth in different cell densities, but on the number of cells with 
clonogenic potential before growing in identical cell densities.

\[SF_x(C) = \frac{S_0(C)}{S_x(C)} 
        = exp\left( \frac{log\left(\frac{C}{a_0}\right)}{b_0}
          - \frac{log\left(\frac{C}{a_x}\right)}{b_x}\right)\]

Obviously, for $b_x = b_0 = 1$ the equivalence $SF_x(C) \equiv SF'$ holds for 
all $C$, and thus, the 
non-cooperative case is well covered by the new method. 
At the same time, the conventional determination of clonogenic survival is 
heavily compromised by cellular cooperation, if present.

## Getting Started ##

The data as presented in Brix et al. is included in the package in form of 
a data.frame *CFAdata*. 
It can be loaded and summarized by 

```{r loadData}
library(CFAcoop)
data("CFAdata")
summary(CFAdata)
```

# Fast Analysis and Plotting of Results

The shortcut to analyse data, is using the wrapper 
function `` `analyse_survival(RD, name, xtreat)` ``
where RD is a `` `data.frame` `` or `` `matrix` `` containing your numbers of
seeded cells (first column) and numbers of colonies counted under the 
treatments (numeric argument, e.g. the dose 
applied `` `xtreat = c(0,1,2,4,6,8)` ``).

The returned objects should be concatenated in a list-object and can be plotted 
by `` `plot_sf()` ``.

```{r show1, fig.width=7, fig.height=5}
data("CFAdata")
data1 <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "T47D")
data2 <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "BT20")
SF <- vector("list", 2)
SF[[1]] <- analyse_survival(
  RD = data1[, c("Cells seeded","0 Gy","1 Gy","2 Gy","4 Gy","6 Gy","8 Gy")], 
  name = data1[1,1], 
  xtreat = c(0, 1, 2, 4, 6, 8), 
  c_range = c(5, 100))
SF[[2]] <- analyse_survival(
  RD = data2[,-1], 
  name = data2[1,1], 
  xtreat = c(0, 1, 2, 4, 6, 8))
plot_sf(SF = SF)
```

All information used for plotting is contained in the objects returned by 
`` `analyse_survival` ``. 
For instance, the information about the regression of the 0 Gy reference of the 
cell line BT20 or the survival fractions of the 5 treatments for T47D (at $C = 5$
and $C = 100$) can be recalled by 
```{r sf_details}
SF[[1]]$fit[1]
SF[[2]]$SF
```

# Details for Focussed Analysis

## Assess Cellular Cooperation

Key to the robust analysis of clonogenic analysis data, is the modeling of the 
cellular cooperation. 
We assume, that the underlying functional dependency of seeded cells and counted 
colonies is of the form
\[C = a \cdot S^{b}\]
where $b$ indicates the degree of cooperativity 
($b = 1$ is implicitely assumed for the PE-based approach).

The cooperativity coefficient $b$ is estimated in a linear regression model
\[log(C) = log(a) + b \cdot log(S) + \varepsilon, \varepsilon \sim \mathcal{N}(0,\sigma^2). \]

The function `` `pwr_reg(seede, counted)` `` provides this regression and 
returns a `` `summary.lm` `` object.

Note, that the analysis of the cellular cooperation is restricted to the range 
of seeded cells, where at least one colony was observed. 
Outside this range, the attempt of studying clonogenic survival based on no 
observed colonies is not reasonable and thus, `` `pwr_reg` `` will remove those 
data points from analysis. 
Thus, it is strongly recommended to use the averaged data for regression.
By doing so, the range of the independent variable of the regression is widened
(removing only those replicates with no colonies would bias the model fitting).

```{r PowerReg, fig.width=7, fig.height=5}
data <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "BT20")
data <- aggregate(x = data[, -1], by = list(data$`Cells seeded`), FUN = "mean", na.rm = TRUE)
par_0 <- pwr_reg(seeded = data$`Cells seeded`, counted = data$`0 Gy`)
par_0$coefficients
plot(x = log10(data$`Cells seeded`), y = log10(data$`0 Gy`),xlim = c(2,3.5))
abline(a = log10(exp(1)) * par_0$coefficients[1, 1], b = par_0$coefficients[2, 1])
```

With the results of this function, we can also test for cellular cooperation.
Note, that the _p-value_ in the _coefficients_ table corresponds to the 
Null-hypothesis $b = 0$, but we are interested in the Null-hypothesis of 
$b \leq 1$. 
Thus, we find our p-value of interest by computing

```{r TestingCooperation, fig.width=7, fig.height=5}
p_value <-
  (1 - pt(
    q = (par_0$coefficients[2, 1] - 1) / par_0$coefficients[2, 2],
    df = par_0$df[2]
  ))
```

Thus, BT20 is higly cooperative 
($b = 1.76$, $\hat{\sigma}_b = 0.12$, $p < 0.001$).

## Determine Clonogenic Survival Fractions

In this package, the survival fraction $SF(C)$ for clonogenic survival is 
calculated as the number of cells that need to be seeded without treatment 
divided by the number of cells needed to be seeded with treatment for obtaining 
the same expectation of colonies counted $C$.
\[ SF(C) = \frac{S_0(C)}{S_x(C)} = exp\left( \frac{log\left(\frac{C}{a_0}\right)}{b_0} - \frac{log\left(\frac{C}{a_x}\right)}{b_x} \right)\]

So given two parameter sets of clonogenic assay data, the clonogenic survival 
can be calculated as
```{r calculateSF}
data <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "BT20")
data <- aggregate(x = data[, -1], by = list(data$`Cells seeded`), FUN = "mean", na.rm = TRUE)
par_0 <- pwr_reg(seeded = data$`Cells seeded`, counted = data$`0 Gy`)
par_4 <- pwr_reg(seeded = data$`Cells seeded`, counted = data$`4 Gy`)
calculate_sf(par_ref = par_0, par_treat = par_4, c_range = c(5, 100))
```

Since the SF-values are solely dependent on the estimated parameters in the 
power regression, the inherent uncertainty can be assessed via parametric 
bootstrapping, namely
```{r bootstrapUncertainty}
ParSet_0 <- mvtnorm::rmvnorm(n = 10^4,mean = par_0$coefficients[,1],
                             sigma = vcov(object = par_0))
ParSet_4 <- mvtnorm::rmvnorm(n = 10^4,mean = par_4$coefficients[,1],
                             sigma = vcov(object = par_4))
parbootstrap <- calculate_sf(par_ref = ParSet_0, 
                             par_treat = ParSet_4, 
                             c_range = c(5, 100))
cat(c(mean(parbootstrap),sd(parbootstrap)))
cat(quantile(x = parbootstrap,probs = c(0.025,0.5,0.975)))
```


### Remark on Ignoring Cellular Cooperation 
Note that in case of cooperative cell lines, the parameter $a$ does not 
correspondence to a plating efficiency as for non-cooperative cell lines.
The concept of a characteristic plating efficiency does not apply to 
cooperative cell lines.

# What's the problem with PE-based analysis? #

In short: nothing, unless you face cellular cooperation.

For calculating the survival fraction, plating efficiencies are required.
The plating efficiencies are calculated easily, but which values are to be 
compared?

```{r PEfail, fig.width=6, fig.height=5}
data(CFAdata)
data <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "T47D")
data <- aggregate(x = data[, -1], by = list(data$`Cells seeded`), FUN = "mean", na.rm = TRUE)
PE_x <- data$`4 Gy` / data$`Cells seeded`
PE_0 <- data$`0 Gy` / data$`Cells seeded`
plot(x = rep(c(0, 1), each = 18), y = c(PE_0, PE_x), lty = 0)
SF_resample <- rep(PE_x, each = length(PE_0)) / rep(PE_0, times = length(PE_x))
hist(SF_resample, breaks = 25,xlim = c(0.12,0.25))
```

Keep in mind, that not taking cellular cooparation into account, leads 
precisely to the situation above.
This is, because the underlying model is invariant under changes in the 
number of cells seeded and thus, theoretically all those SF-values are 
equally reliable.


```{r PEfail2, fig.width=6, fig.height=5}
range(SF_resample,na.rm = TRUE)
as_nc_0 <- analyse_survival(RD = data[,-1],c_range = c(40))
as_nc_0$uncertainty[[3]]
```

Thus, for non-cooperating cells, there is no big difference between the 
conventional and the new method with regard to the estimated 
SF-values or the associated uncertainties.

Now, comparing the same entities in the cooperative cell line BT20 shows the 
disastrous effect of ignoring the coefficient $b$, when it is different 
from $1$.

```{r PEfailCoop, fig.width=6, fig.height=5}
data(CFAdata)
data <- subset.data.frame(x = CFAdata, subset = CFAdata$cell.line == "BT20")
data <- aggregate(x = data[, -1], by = list(data$`Cells seeded`), FUN = "mean", na.rm = TRUE)
PE_x <- data$`4 Gy` / data$`Cells seeded`
PE_0 <- data$`0 Gy` / data$`Cells seeded`
plot(x = rep(c(0, 1), each = length(PE_x)), y = c(PE_0, PE_x), lty = 0)
SF_resample <- rep(PE_x, each = length(PE_0)) / rep(PE_0, times = length(PE_x))
hist(SF_resample, breaks = 100,xlim = c(0,10))
```


```{r PEfailCoop2, fig.width=6, fig.height=5}
range(SF_resample,na.rm = TRUE)
as_c_4 <- analyse_survival(RD = data[,-1],c_range = c(40))
as_c_4$uncertainty[[3]]
```

Thus, before calculating PE-based survival fractions, one must check, whether 
there is cellular cooperativity or not.

Essentially, to decide, whether you have a cooperativity issue or not, 
you need to conduct the same analysis and the same data 
that is necessary to solve this issue anyways.

<!-- # Full CFAdata Set -->
<!-- ```{r Full, fig.width=13, fig.height=6} -->
<!-- data("CFAdata") -->
<!-- SF <- vector('list',7) -->
<!-- for (i in seq_along(SF)){ -->
<!--   SF[[i]] <- analyse_survival( -->
<!--     RD = subset.data.frame(x = CFAdata, -->
<!--                            subset = CFAdata$cell.line==levels(CFAdata$cell.line)[i])[,-1], -->
<!--     name = levels(CFAdata$cell.line)[i], -->
<!--     xtreat = c(0,1,2,4,6,8), -->
<!--     c_range = c(5,100)) -->
<!-- } -->
<!-- plot_sf(SF) -->
<!-- ``` -->
